# Implementation Plan: Add rsync-based File Sync to `sb sync`

## Context

The `sb sync` command currently refreshes sandbox configuration (`.env`), rebuilds the Docker image, reinstalls modules, and recreates the container. There is no mechanism to copy arbitrary files from the host filesystem into the sandbox container filesystem.

This plan adds a `sync_files()` function to `bin/sb` that reads YAML sync specifications and uses `rsync` + `docker compose cp` to copy files from the host into sandbox containers. The function integrates into `sandbox_sync()` and supports three YAML file sources (processed in the order listed):

  - sandbox-level (`sb-sandbox-sync.yml`)
  - project-level (`sb-project-sync.yml`)
  - user-level (`user-sync.yml`) 

## Confirmed Design Decisions

- **YAML structure**: `sync.spec` is nested (i.e., `spec` is a child of `sync`). Accessed via `yq '.sync.spec'`.

- **Resolving references to tokens in paths**

  - For values of `sync.spec.sandbox.path`:
    - **Token prefix**: Interpret any token with prefix `__ENV__` (double trailing underscore) as a reference to a value in the sandbox `.env` file. For example, `__ENV__SB_LOGIN_USER_HOME` resolves to the value of `SB_LOGIN_USER_HOME` from the sandbox `.env` file. The regex to match tokens is `__ENV__[A-Za-z_][A-Za-z0-9_]*`.

  - For values of `sync.spec.host.path`:
    - **Bash string interpolation**: use Bash string interpolation to resolve references to environment variables (e.g. `$HOME`, `${HOME}`, `${HOME:+/home/user}`)

- **YAML key names**: `include` and `exclude` (without trailing 's').

- **`host.path`**: An array of strings (matching the YAML examples), supporting Bash variable interpolation.

### Canonical YAML Example

```yaml
sync:
  spec:
    - host:
        path:
          - $HOME/.ssh/my_key
      sandbox:
        path: __ENV__SB_LOGIN_USER_HOME/.ssh
    - host:
        path:
          - $HOME/.config
      sandbox:
        path: __ENV__SB_LOGIN_USER_HOME
        include:
          - '*.env'
          - 'tmux/***'
        exclude:
          - '**/*secrets*'
```

## Files to Modify

| File | Changes |
|------|---------|
| `bin/sb` | Add `sync_files()`, `resolve_sandbox_env_tokens()`, dependency checks; modify `sandbox_sync()` |

## Implementation Tasks

### Task 1: Add dependency check helper functions

**File:** `bin/sb` (place after existing helper functions around line 232, before `get_default_sandbox_id`)

Add two small functions to verify `yq` and `rsync` are installed on the host:

```bash
check_sync_dependencies() {
  local missing=0
  if ! command -v yq &> /dev/null; then
    echo "$SCRIPT_NAME: Error- 'yq' is required for file sync but not found. Install yq: https://github.com/mikefarah/yq"
    missing=1
  fi
  if ! command -v rsync &> /dev/null; then
    echo "$SCRIPT_NAME: Error- 'rsync' is required for file sync but not found"
    missing=1
  fi
  return $missing
}
```

Uses `return` (not `exit`) so the caller can decide how to handle the failure.

---

### Task 2: Add `resolve_sandbox_env_tokens()` helper function

**File:** `bin/sb` (place after Task 1 functions)

Replaces `__ENV__<VARIABLE_NAME>` tokens in a string with values from the sandbox `.env` file.

**Signature:** `resolve_sandbox_env_tokens <string> <env-file-path>`

**Logic:**
1. Extract all tokens matching `__ENV__[A-Za-z_][A-Za-z0-9_]*` from the input string.
2. For each token, extract the variable name (strip `__ENV__` prefix).
3. Look up `VARNAME=value` in the `.env` file using grep.
4. Replace the token with the value. If not found, print error and return 1.
5. Output the resolved string via `echo -n`.

**Key detail:** The `.env` file is generated by `sync_env()` (lines 1040-1124 in `bin/sb`) and contains `KEY=VALUE` lines from sb-project.env, sb-sandbox.env, sb-login.env, sb-compose.env. Values may be quoted with double quotes.

---

### Task 3: Implement `sync_files()` function

**File:** `bin/sb` (place after `resolve_sandbox_env_tokens`, before `sandbox_sync()` at line 773)

**Signature:** `sync_files <yaml-file-path>`

**Globals used** (set by `get_sandbox_cmd_conf` + `eval` before this function is called):
- `$__compose_file` - path to sandbox docker-compose.yml
- `$__compose_env_path` - path to sandbox .env file
- `$__compose_service` - Docker Compose service name (e.g., "sandbox")
- `$__sandbox_root` - sandbox root directory path
- `$__sandbox_id` - sandbox ID

**Logic per spec entry** (iterate `i` from 0 to `spec_count-1`):

1. **Parse YAML with `yq`:**
   - `spec_count=$(yq '.sync.spec | length' "$sync_file")`
   - `host_paths[]` from `yq ".sync.spec[$i].host.path[$j]"`
   - `sandbox_path` from `yq ".sync.spec[$i].sandbox.path"`
   - `include[]` from `yq ".sync.spec[$i].sandbox.include[$k]"` (optional)
   - `exclude[]` from `yq ".sync.spec[$i].sandbox.exclude[$k]"` (optional)

2. **Expand host paths** using `eval echo` for Bash variable interpolation (`$HOME`, etc.)

3. **Resolve sandbox path** tokens via `resolve_sandbox_env_tokens "$raw_sandbox_path" "$__compose_env_path"`

4. **Validate host paths exist** (warn and skip entry if missing)

5. **Create temp directory:** `mktemp -d "/tmp/sb-sync-${__sandbox_id}-XXXXXX"`

6. **Build rsync arguments** with proper ordering:
   - Base: `-rLptgoD`
   - Then: `--include=PATTERN` for each include entry
   - Then: `--exclude=PATTERN` for each exclude entry
   - If includes were specified, append `--exclude=*` (catch-all to exclude non-matched files)
   - Then: source paths and destination

7. **Execute rsync**, save output to `$__sandbox_root/logs/sync-rsync-<timestamp>-spec<i>.log`

8. **Check if temp dir has files** (`find "$temp_dir" -type f | wc -l`)
   - If empty: print info message, clean up temp dir, continue

9. **Execute `docker compose cp`:**
   ```
   docker compose -f "$__compose_file" cp "$temp_dir/." "${__compose_service}:${sandbox_path}"
   ```
   Save output to `$__sandbox_root/logs/sync-compose-cp-<timestamp>-spec<i>.log`

10. **On success:** delete temp dir. **On failure:** print error with paths to temp dir, rsync log, and compose cp log (do not delete temp dir).

**Return:** 0 if all entries succeeded, 1 if any failed.

---

### Task 4: Integrate `sync_files()` into `sandbox_sync()`

**File:** `bin/sb`, function `sandbox_sync()` (lines 773-825)

**Current flow:**
```
sync_env -> sync_image -> sync_modules -> docker compose down -> docker compose create -y
```

**New flow** (add after `docker compose create -y`, before the "Sandbox sync complete" message):

```bash
# Sync sandbox files (if sb-sandbox-sync.yml exists)
if [ -f "$__sandbox_root/sb-sandbox-sync.yml" ]; then
  echo ""
  echo "$SCRIPT_NAME: [Sandbox] Syncing files specified in '$__project_root/sb-sandbox-sync.yml'"
  sync_files "$__sandbox_root/sb-sandbox-sync.yml"
  if [ $? -ne 0 ]; then
    echo "$SCRIPT_NAME: Warning- sandbox file sync encountered errors"
  fi
fi
# Sync project files (if sb-project-sync.yml exists)
if [ -f "$__project_root/sb-project-sync.yml" ]; then
  echo ""
  echo "$SCRIPT_NAME: [Project] Syncing files specified in '$__project_root/sb-project-sync.yml'"
  sync_files "$__project_root/sb-project-sync.yml"
  if [ $? -ne 0 ]; then
    echo "$SCRIPT_NAME: Warning- project file sync encountered errors"
  fi
fi
# Sync user files (if user-sync.yml exists)
if [ -n "$__user_env_root" ] && [ -f "$__user_env_root/user-sync.yml" ]; then
  echo ""
  echo "$SCRIPT_NAME: [User] Syncing files specified in '$__user_env_root/user-sync.yml'"
  sync_files "$__user_env_root/user-sync.yml"
  if [ $? -ne 0 ]; then
    echo "$SCRIPT_NAME: Warning- user file sync encountered errors"
  fi
fi
```

**Design decisions:**
- `sync_files()` runs AFTER `docker compose create -y`. The container exists in `created` state. `docker compose cp` works on created (stopped) containers.
- File sync failures are **warnings**, not fatal errors. The core sync operations (env/image/modules/container) are not affected.
- `$__user_env_root` is already resolved by `get_sandbox_cmd_conf()` (line 440).
- `$__project_root` is the absolute path to the `.sb/` project directory, already resolved by `get_sandbox_cmd_conf()` (line 441).

---

### Task 5: Verify `docker compose cp` works on created-but-not-running containers

**Manual verification before implementation:**
1. Create a sandbox: `sb new`
2. `docker compose -f <compose-file> create -y`
3. Verify container state: `docker compose -f <compose-file> ps -a` (should show `created`)
4. Attempt: `docker compose -f <compose-file> cp ./test-file sandbox:/tmp/`
5. If this fails, the implementation must wrap sync_files calls with `docker compose start` / `docker compose stop`

---

## Verification Plan

### Create and Run Unit Tests

Generate bash scripts that execute the following units tests:

- `resolve_sandbox_env_tokens`: Create a test `.env` file with known values, call `resolve_sandbox_env_tokens` with tokens, verify output matches expected values.

The test scripts should:

- Use the 'Bats' test framework for Bash script. Refer to https://github.com/bats-core/bats-core for Bats code/examples and https://bats-core.readthedocs.io/en/stable/ for Bats user documentation.

### Manual Tests

1. **Test with user-sync.yml:** Create a `user-sync.yml` in `$SB_USER_ENV_ROOT` that syncs a test file from the host. Run `sb sync`. Verify the file appears in the container with `sb shell` + `ls`.

2. **Test with sb-project-sync.yml:** Create `sb-project-sync.yml` in the project `.sb/` directory with include/exclude patterns. Run `sb sync`. Verify only matching files appear.

3. **Test with sb-sandbox-sync.yml:** Create `sb-sandbox-sync.yml` in a  test sandbox directory with include/exclude patterns. Run `sb sync`. Verify only matching files appear.

4. **Test edge cases:**
   - Missing host path (should warn and skip)
   - Missing `yq`/`rsync` (should error with install instructions)
   - Empty spec array (should print info and return cleanly)
   - `__ENV__` token for nonexistent variable (should error)

5. **Check log files:** After sync, verify log files exist in `$__sandbox_root/logs/` with rsync and docker compose cp output.
