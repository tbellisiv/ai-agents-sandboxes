name: "${SB_COMPOSE_PROJECT_NAME:?specify a value in profile .env}"
services:
    sandbox:
        image: ${SB_PROFILE_IMAGE_ID:?specify a value in profile .env}}
        build:
            context: .
            dockerfile: Dockerfile
            args:
                SB_ARG_SUHASH: ''
                SB_ARG_TZ: ${SB_PROFILE_TZ:?specify a value in profile .env}}
                SB_ARG_USERNAME: ${SB_PROFILE_USERNAME:?specify a value in profile .env}
        cap_drop:
            - ALL
        cap_add:
            # firewall:
            - NET_ADMIN
            - NET_RAW
            # sudo/root:
            - SETUID
            - SETGID
            - DAC_OVERRIDE
            - CHOWN
        pids_limit: 500 # prevent fork bombs
        mem_limit: 8G
        ipc: private # isolate IPC namespace
        tmpfs:
            - /tmp:size=1G # ephemeral /tmp
        ulimits:
            nofile:
                soft: 65536
                hard: 65536
        container_name: sandbox
        environment:
            - TZ=${SB_PROFILE_TZ}
            - SB_PROFILE_ID=${SB_PROFILE_ID?specify a value in profile .env}
            - SB_SESSION_ID=${SB_SESSION_ID?specify a value in session .env}
            - NODE_OPTIONS=--max-old-space-size=4096
            # gemini CLI OAuth callback for "Login with Google" (fixed port for container port forwarding):
            - OAUTH_CALLBACK_PORT=7777
            - OAUTH_CALLBACK_HOST=0.0.0.0
            - 
        volumes:
            # workspace files
            - .:/workspace:delegated

            # agent init
            - 

            # TIME/TZ
            - /etc/localtime:/etc/localtime:ro
            - /etc/timezone:/etc/timezone:ro
            
            # persist volumes:
            - bashhistory:/commandhistory
            - claude-config:/home/node/.claude
            - gemini-config:/home/node/.gemini
                 
volumes:
    bashhistory:
        name: ${SB_PROFILE_IMAGE_ID}-bashhistory
    claude-config:
        name: ${SB_PROFILE_IMAGE_ID}-claude-config
    gemini-config:
        name: ${SB_PROFILE_IMAGE_ID}-gemini-config

