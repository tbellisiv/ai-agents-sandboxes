#!/bin/bash

set -eu

# shellcheck disable=SC2034

SCRIPT_NAME=$(basename $0)    #equivalent to ${0##*/}
SCRIPT_DIR=$(dirname $0)
SCRIPT_VERSION=0.1

LIB_DIR=$SCRIPT_DIR/../lib

GETOPTIONS_LIB_PATH=$LIB_DIR/getoptions_lib

if [ ! -f "$GETOPTIONS_LIB_PATH" ]; then
    echo "$SCRIPT_NAME: Aborting- library '$GETOPTIONS_LIB_PATH' does not exist"
    exit -1
fi

. $GETOPTIONS_LIB_PATH

parser_definition() {

	setup   REST help:usage abbr:true -- "Usage: $SCRIPT_NAME [<global-options>] [<command>] [<command-options>]"

	msg -- '' "${SCRIPT_NAME}: AI Agent Sandbox Management" ''

	msg -- 'Options:'

	flag    GLOBAL  -g --global    -- "global flag"
	disp    :usage  -h --help
	disp    SCRIPT_VERSION    --version

	msg         -- '' 'Commands:'
	cmd profile-init -- "Management of sandbox profiles (init)"
	cmd profile-sync -- "Management of sandbox profile sessions (new, env, stop, start, status, sync, etc.)"
}

parser_definition_profile() {
	setup   REST help:usage abbr:true -- "Usage: $SCRIPT_NAME profile <command> [<options>]"
	msg -- '' 'Sandbox profile management commands (init, sync, etc.)' ''
	msg -- 'Options:'
	disp    :usage  -h --help
	cmd init -- "Generate configuration for a new sandbox environment"
	cmd sync -- "Sync (i.e.update) the Docker image and compose spec with updates from the root"
}

parser_definition_profile_init) {
	setup   REST help:usage abbr:true -- "Usage: $SCRIPT_NAME profile init <options>"
	msg -- '' 'Creates a new sandbox profile' ''
	msg -- 'Options:'
	disp    :usage  -h --help
	cmd init -- "Generate configuration for a new sandbox environment"
	cmd sync -- "Sync (i.e.update) the Docker image and compose spec with updates from the root"
}

parser_definition_session() {
	setup   REST help:usage abbr:true -- "Usage: $SCRIPT_NAME session <command> <options>"
	msg -- '' 'Sandbox Session Management (new, delete, stop, start, sync, etc.)' ''
	msg -- 'Options:'
	disp    :usage  -h --help
	cmd env -- "Create a new session in an existing sandbox environment"
}

parser_definition_session_env() {
	setup   REST help:usage abbr:true -- "Usage: $SCRIPT_NAME session <command> <options>"
	msg -- '' 'Session-related configuration commands' ''
	msg -- 'Options:'
	disp    :usage  -h --help
	cmd dump -- "Dumps session configuration"
}



eval "$(getoptions parser_definition) exit 1"

if [ $# -gt 0 ]; then
	cmd=$1
	shift
	case $cmd in
		cmd1)
			eval "$(getoptions parser_definition_profile)"
			;;
		cmd2)
			eval "$(getoptions parser_definition_profile_init)"
			;;
		cmd3)
			eval "$(getoptions parser_definition_session)"
			;;
		--) # no subcommand, arguments only
	esac
fi

echo "GLOBAL: $GLOBAL"
i=0
while [ $# -gt 0 ] && i=$((i + 1)); do
	echo "$i: $1"
	shift
done