#!/bin/bash

# shellcheck disable=SC2034

SCRIPT_NAME=$(basename $0)    #equivalent to ${0##*/}
SCRIPT_DIR=$(dirname $0)
SCRIPT_VERSION=0.1

LIB_DIR=$SCRIPT_DIR/../lib

GETOPTIONS_LIB_PATH=$LIB_DIR/getoptions_lib

if [ ! -f "$GETOPTIONS_LIB_PATH" ]; then
    echo "$SCRIPT_NAME: Aborting- library '$GETOPTIONS_LIB_PATH' does not exist"
    exit -1
fi

. $GETOPTIONS_LIB_PATH

parser_definition() {

	setup   REST help:usage abbr:true -- "Usage: $SCRIPT_NAME [<command>] [<command-options>]"

	msg -- '' "${SCRIPT_NAME}: Commands for managing sandbox projects (init, etc.)" ''

	msg -- 'Options:'

	disp    :usage  -h --help
	disp    SCRIPT_VERSION    --version

	msg         -- '' 'Commands:'
	cmd init -- "Creates a new session project"
}

parser_definition_init() {
	setup   REST error:error_init help:usage abbr:true -- "Usage: $SCRIPT_NAME init [<options>]"
	msg -- '' 'Generates a new sandox project structure'
	msg -- 'Options:'
	param   id            -i    --project-id    validate:'regex "^[a-zA-Z](-|_|[a-zA-z]|[0-9]$)*"'    -- "(Required) The project ID. A meaningful but short identifier. Used as the prefix for names of sandboxes created in the project."
  param   path          -p    --project-path   init:="./.sb"                                        -- "The directory to create for the project files (project root). Defaults to \$PWD/.sb"
	disp    :usage        -h    --help
}

regex() {
	awk -v s="$OPTARG" -v r="$1" 'BEGIN{exit match(s, r)==0}'
}

error_init() {
	
  case $2 in
		regex:*) echo "$SCRIPT_NAME: Error: The project ID specified in option '-p <id>' ('--project-id <id>') is not a valid identifier (does not match regex '$5')" ;;
		*) return 0 ;; # Display default error
	esac
	return 1
}


init_project() {

  if [ -z "$id" ]; then
    usage
    exit 1
  fi

  path_abs=$(readlink -f $path)

  if [ -d "${path_abs}" ]; then
    echo "$SCRIPT_NAME: Error: Cannot create project root directory '$path_abs' (directory exists)"
    exit 1
  fi

  #Read the user's global defaults (if present)
  SB_USER_ENV_PATH=
  if [ -n "$SB_USER_ENV_ROOT" ]; then
    SB_USER_ENV_PATH=$SB_USER_ENV_ROOT
  elif [[ -v XDG_CONFIG_HOME && -f "$XDG_CONFIG_HOME/sb-user.env" ]]; then
    SB_USER_ENV_PATH="$XDG_CONFIG_HOME/sb-user.env"
  elif [ -f "$HOME/.config/sb/sb-user.env" ]; then
    SB_USER_ENV_PATH="$HOME/.config/sb/sb-user.env"
  elif [ -f "$HOME/.sb/sb-user.env" ]; then
    SB_USER_ENV_PATH="$$HOME/.sb/sb-user.env"
  fi

  if [ -n "$SB_USER_ENV_PATH" ]; then
    source "$SB_USER_ENV_PATH"
  fi

  echo "$SCRIPT_NAME: Creating dir : $path_abs"
  mkdir -p $path_abs
  if [ $? -ne 0 ]; then
		echo  "$SCRIPT_NAME: Error: Failed to create project root directory '$path_abs'"
		exit 1
	fi

  project_modules_dir_path=$path_abs/modules
  project_example_module_dir_path=$project_modules_dir_path/project-example

  project_env_path="$path_abs/sb-project.env"
  echo "$SCRIPT_NAME: Creating file: $project_env_path"
  cat <<EOF > $project_env_path
SB_PROJECT_ID="$id"
SB_PROJECT_PREFIX="sandbox-"
SB_PROJECT_TZ="$(timedatectl status | grep "Time zone" | awk '{print $3}')"
SB_PROJECT_WORKSPACE_MAIN_ROOT=$(readlink -f $path_abs/..)
SB_PROJECT_MODULE_SEARCH_PATH="${project_modules_dir_path}"
#SB_PROJECT_DEFAULT_MODULES=("$(basename $project_example_module_dir_path)")
#SB_PROJECT_DEFAULT_SANDBOX_ID=
#SB_PROJECT_DEFAULT_TEMPLATE_ID=
EOF
  if [ $? -ne 0 ]; then
		echo  "Failed\n$SCRIPT_NAME: Error: Failed to create project file '$project_env_path'"
		exit 1
	fi

  project_compose_volumes_path="$path_abs/sb-project-compose-include.yml"
  echo "$SCRIPT_NAME: Creating file: $project_compose_volumes_path"
  cat <<EOF > $project_compose_volumes_path
# Example: Mount an additional dev project into the container
#
# services:
#   sandbox:
#         volumes:
#             # Mount another_project/ in the host to /workspace/another_project
#             - workspace_main:/workspace/user_another_project:delegated    
# volumes:
#     user_another_project:
#         driver: local
#         driver_opts:
#             type: none
#             device: /path/to/another_project
#             o: bind
EOF
  if [ $? -ne 0 ]; then
		echo  "Failed\n$SCRIPT_NAME: Error: Failed to create project file '$project_compose_volumes_path'"
		exit 1
	fi

  echo "$SCRIPT_NAME: Creating dir : ${project_modules_dir_path}/"
  mkdir -p $project_modules_dir_path
  if [ $? -ne 0 ]; then
		echo  "$SCRIPT_NAME: Aborting sandbox project initialization- failed to create directory '$project_modules_dir_path'"
		exit 1
	fi

  echo "$SCRIPT_NAME: Creating dir : ${project_example_module_dir_path}/"
  mkdir -p $project_example_module_dir_path
  if [ $? -ne 0 ]; then
		echo  "$SCRIPT_NAME: Aborting sandbox project initialization- failed to create directory '$project_example_module_dir_path'"
		exit 1
	fi

  module_readme_path=$project_example_module_dir_path/README.md
  echo "$SCRIPT_NAME: Creating file: ${module_readme_path}"
  cat <<EOF > $module_readme_path
# Example Sandbox Module
EOF
  if [ $? -ne 0 ]; then
		echo  "$SCRIPT_NAME: Aborting sandbox project initialization- failed to create file '$module_readme_path'"
		exit 1
	fi

  artifacts_dir=${project_example_module_dir_path}/artifacts
  echo "$SCRIPT_NAME: Creating dir : ${artifacts_dir}/"
  mkdir -p $artifacts_dir
  if [ $? -ne 0 ]; then
		echo  "$SCRIPT_NAME: Aborting sandbox project initialization- failed to create directory '$artifacts_dir'"
		exit 1
	fi

  artifacts_readme_path=$artifacts_dir/README.md
  echo "$SCRIPT_NAME: Creating file: ${artifacts_readme_path}"
  cat <<EOF > $artifacts_readme_path
Add any dependencies required for the module hooks (configuration files, scripts) here.
EOF
  if [ $? -ne 0 ]; then
		echo  "$SCRIPT_NAME: Aborting sandbox project initialization- failed to create file '$artifacts_readme_path'"
		exit 1
	fi

  hooks_dir=${project_example_module_dir_path}/hooks
  echo "$SCRIPT_NAME: Creating dir : ${hooks_dir}/"
  mkdir -p $hooks_dir
  if [ $? -ne 0 ]; then
		echo  "$SCRIPT_NAME: Aborting sandbox project initialization- failed to create directory '$hooks_dir'"
		exit 1
	fi

  init_hooks_dir=${hooks_dir}/init
  echo "$SCRIPT_NAME: Creating dir : ${init_hooks_dir}/"
  mkdir -p $init_hooks_dir
  if [ $? -ne 0 ]; then
		echo  "$SCRIPT_NAME: Aborting sandbox user config initialization- failed to create directory '$init_hooks_dir'"
		exit 1
	fi

  shell_login_hooks_dir=${hooks_dir}/shell-login
  echo "$SCRIPT_NAME: Creating dir : ${shell_login_hooks_dir}/"
  mkdir -p $shell_login_hooks_dir
  if [ $? -ne 0 ]; then
		echo  "$SCRIPT_NAME: Aborting sandbox user config initialization- failed to create directory '$shell_login_hooks_dir'"
		exit 1
	fi

  hook_init_script_path=$init_hooks_dir/init.sh
  echo "$SCRIPT_NAME: Creating file: ${hook_init_script_path}"
  cat <<EOF > $hook_init_script_path
#! /bin/bash

SCRIPT_DIR=\$(readlink -f \$(dirname \$0))
SCRIPT_NAME=\$(basename \$0)

MODULE_DIR=\$(readlink -f \$SCRIPT_DIR/../..)
MODULE_NAME=\$(basename \$MODULE_DIR)
MODULE_HOOK=\$(basename \$SCRIPT_NAME ".sh")

ARTIFACTS_DIR=\$MODULE_DIR/artifacts

SCRIPT_MSG_PREFIX="[module=\$MODULE_NAME hook=\$MODULE_HOOK]"

echo "\$SCRIPT_MSG_PREFIX: Initializing"

echo "\$SCRIPT_MSG_PREFIX: Initialization complete"

exit 0
EOF
  if [ $? -ne 0 ]; then
		echo  "$SCRIPT_NAME: Aborting sandbox project initialization- failed to create file '$hook_init_script_path'"
		exit 1
	fi

  chmod 755 $hook_init_script_path
  if [ $? -ne 0 ]; then
		echo  "$SCRIPT_NAME: Error: Aborting sandbox project- initialization- failed to set execute permissions on file '$hook_init_script_path'"
		exit 1
	fi

  hook_shell_login_script_path=$shell_login_hooks_dir/login.sh
  echo "$SCRIPT_NAME: Creating file: ${hook_shell_login_script_path}"
  cat <<EOF > $hook_shell_login_script_path
#! /bin/bash

SCRIPT_DIR=\$(readlink -f \$(dirname \$0))
SCRIPT_NAME=\$(basename \$0)

MODULE_DIR=\$(readlink -f \$SCRIPT_DIR/../..)
MODULE_NAME=\$(basename \$MODULE_DIR)
MODULE_HOOK=\$(basename \$SCRIPT_NAME ".sh")

ARTIFACTS_DIR=\$MODULE_DIR/artifacts

SCRIPT_MSG_PREFIX="[module=\$MODULE_NAME hook=\$MODULE_HOOK]"

exit 0
EOF
  if [ $? -ne 0 ]; then
		echo  "$SCRIPT_NAME: Aborting sandbox user config initialization- failed to create file '$hook_shell_login_script_path'"
		exit 1
	fi

  chmod 755 $hook_shell_login_script_path
  if [ $? -ne 0 ]; then
		echo  "$SCRIPT_NAME: Error: Aborting sandbox user config initialization- failed to set execute permissions on file '$hook_shell_login_script_path'"
		exit 1
	fi


  sandboxes_root_dir=$path_abs/sandboxes
  echo "$SCRIPT_NAME: Creating dir : ${sandboxes_root_dir}/"
  mkdir -p $sandboxes_root_dir
  if [ $? -ne 0 ]; then
		echo  "Failed\n$SCRIPT_NAME: Error: Failed to create sandboxes directory '$sandboxes_root_dir'"
		exit 1
	fi

  sandboxes_readme_path=$sandboxes_root_dir/README.md
  echo "$SCRIPT_NAME: Creating file: $sandboxes_readme_path"
  cat <<EOF > $sandboxes_readme_path
# Project Sandboxes Diectory

This directory contains sandboxes created within the project.

Run \`sb new\` to create a "default" sandbox. Any \`sb\` commands that do not specify a sandbox ID on the command-line (e.g. \`sb start\`) will operate on the default sandbox.

Run \`sb new <sandbox-id>\` to create a named sandbox. Running \`sb\` commands for a named sandbox requires specifying the ID on the command line (e.g. \`sb start my-sandbox\`).
EOF
  if [ $? -ne 0 ]; then
		echo  "$SCRIPT_NAME: Aborting sandbox project initialization- failed to create file $sandboxes_readme_path"
		exit 1
	fi

  echo ""
  
  echo "$SCRIPT_NAME: Initialization of sandbox project '$id' complete."
  echo ""
  echo "$SCRIPT_NAME: Project directory: $path_abs"
  echo ""
  echo "$SCRIPT_NAME: Run 'sb new' to create the default sandbox."
  echo ""
  echo "$SCRIPT_NAME: Run 'sb new <sandbox-id>' to create a named sandbox."
  echo ""
  
}

eval "$(getoptions parser_definition) exit 1"

if [ $# -gt 0 ]; then
	cmd=$1
	shift
	case $cmd in
		init)
			  cmd_parser="$(getoptions parser_definition_init)"
        eval "$cmd_parser"
        init_project
			  ;;

		--) # no subcommand, arguments only
	esac
else
    usage
fi
