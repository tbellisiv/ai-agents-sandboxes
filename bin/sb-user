#!/bin/bash

set -u

# shellcheck disable=SC2034

SCRIPT_NAME=$(basename $0)    #equivalent to ${0##*/}
SCRIPT_DIR=$(dirname $0)
SCRIPT_VERSION=0.1

LIB_DIR=$SCRIPT_DIR/../lib

GETOPTIONS_LIB_PATH=$LIB_DIR/getoptions_lib

if [ ! -f "$GETOPTIONS_LIB_PATH" ]; then
    echo "$SCRIPT_NAME: Aborting- library '$GETOPTIONS_LIB_PATH' does not exist"
    exit -1
fi

. $GETOPTIONS_LIB_PATH

parser_definition() {

	setup   REST help:usage abbr:true -- "Usage: $SCRIPT_NAME [<command>] [<command-options>]"

	msg -- '' "${SCRIPT_NAME}: Commands for managing user configuration (init, etc.)" ''

	msg -- 'Options:'

	disp    :usage  -h --help
	disp    SCRIPT_VERSION    --version

	msg         -- '' 'Commands:'
	cmd init -- "Generates user configuration files"
}

parser_definition_init() {
	setup   REST error:error_init help:usage abbr:true -- "Usage: $SCRIPT_NAME init [<options>]"
	msg -- '' 'Generates user-level sandbox configuration files'
	msg -- 'Options:'
	disp    :usage        -h    --help
}

regex() {
	awk -v s="$OPTARG" -v r="$1" 'BEGIN{exit match(s, r)==0}'
}

init_user_env() {

	user_config_root=
  user_sb_env_root=
  if [[ -v XDG_CONFIG_HOME && -d "$XDG_CONFIG_HOME" ]]; then
    user_config_root="$XDG_CONFIG_HOME"
    user_sb_env_root="$user_config_root/sb"
  elif [ -d "$HOME/.config" ]; then
    user_config_root="$HOME/.config"
    user_sb_env_root="$user_config_root/sb"
  else
    user_config_root="$HOME"
    user_sb_env_root="$user_config_root/.sb"
  fi

  user_config_root_abs=$(readlink -f $user_config_root)
  user_sb_env_root_abs=$(readlink -f $user_sb_env_root)

  if [ ! -d "$user_config_root_abs" ]; then
    echo "$SCRIPT_NAME: Sandbox user config initialization failed- unable to detect default user config directory"
    exit 1
  fi

  if [ -d "$user_sb_env_root_abs" ]; then
    echo "$SCRIPT_NAME: Aborting sandbox user config initialization- directory '$user_sb_env_root_abs' exists"
    exit 1
  fi

  echo ""

  echo "$SCRIPT_NAME: Creating dir : $user_sb_env_root"
  mkdir -p $user_sb_env_root
  if [ $? -ne 0 ]; then
		echo  "$SCRIPT_NAME: Aborting sandbox user config initialization- failed to create project root directory '$user_sb_env_root'"
		exit 1
	fi
  
  sb_install_root=$SCRIPT_DIR/..
	user_init_template_root=$sb_install_root/templates/user/user-init
	if [ ! -d "$user_init_template_root" ]; then
		echo "$SCRIPT_NAME: Error: Unable to create new sandbox user configuration- templates directory '${user_init_template_root}' does not exist"
		exit 1
	fi

  echo "$SCRIPT_NAME: Copying template files"
  cp -r $user_init_template_root/* "$user_sb_env_root"
  if [ $? -ne 0 ]; then
    echo  "$SCRIPT_NAME: Aborting sandbox user config initialization- template file copy failed"
    exit 1
  fi

  token_map="__USER_ENV_ROOT__=$user_sb_env_root"
  
  #add another mapping
  #token_map+=$'\\n'
  #token_map+="__SOME_OTHER_TOKEN=some_other_value"

  token_replacement_sed_script=$(echo "$token_map" | sed -r 's/^\s*(\S*)\s*=\s*(.*\S)\s*$/s@\1@\2@g/')
  if [ $? -ne 0 ]; then
    echo  "$SCRIPT_NAME: Aborting sandbox user config initialization- token replacement script generation failed"
    exit 1
  fi

  echo "$SCRIPT_NAME: Applying post-copy updates: user.env"
  user_env_path=$user_sb_env_root/user.env
  sed -i "$token_replacement_sed_script" "$user_env_path"
    if [ $? -ne 0 ]; then
    echo  "$SCRIPT_NAME: Aborting sandbox user config initialization- token replacement script execution failed"
    exit 1
  fi

  echo ""
  echo "$SCRIPT_NAME: Initialization complete"
  echo ""
  echo "$SCRIPT_NAME: User configuration directory: $user_sb_env_root"
  echo ""
  echo "$SCRIPT_NAME: Next Steps: Modify your Bash (or other shell) startup file to set the 'SB_USER_ENV_ROOT' environment variable:"
  echo ""
  echo "$SCRIPT_NAME:      export SB_USER_ENV_ROOT=\"$user_sb_env_root\""
  echo ""
  echo
}

eval "$(getoptions parser_definition) exit 1"

if [ $# -gt 0 ]; then
	cmd=$1
	shift
	case $cmd in
		init)
			  cmd_parser="$(getoptions parser_definition_init)"
        eval "$cmd_parser"
        init_user_env
			  ;;

		--) # no subcommand, arguments only
	esac
else
    usage
fi
